---
layout: lab
title: Installing Clair
permalink: /lab/clair/installing/
module: Clair
---

Open the **Super User Admin Panel** and go to **Registry Settings**.

Go to **Security Scanner** and enable security scanning.

Verify a valid key for `security_scanner` exists and enter the Security Scanner Endpoint: `http://clair:6060`.

Select **Save Configuration Changes**.

To connect Quay Enterprise securely to the scanner, select the key graphic on the **Super User Admin Panel**.

Select **Have the service provide a key**.

Connect to the database. Enter password `coreostrainme`

```
kubectl -n quay-enterprise run -it --rm --image=postgres:10 --restart=Never psql -- psql -h quay-postgres-service -U coreosuser -d enterpriseregistrydb
```

Once you are at the database prompt, create a new database named clair, confirm, and quit.

```
enterpriseregistrydb=# create database clair;
enterpriseregistrydb=# \l;
enterpriseregistrydb=# \quit;
```
```
cat > config.yaml <<EOF
clair:
  database:
    type: pgsql
    options:
      # A PostgreSQL Connection string pointing to the Clair Postgres database.
      # Documentation on the format can be found at: http://www.postgresql.org/docs/9.4/static/libpq-connect.html
      source: postgresql://coreosuser:coreostrainme@quay-postgres-service:5432/clair?sslmode=disable
      cachesize: 16384
  api:
    # The port at which Clair will report its health status. For example, if Clair is running at
    # https://clair.mycompany.com, the health will be reported at
    # http://clair.mycompany.com:6061/health.
    healthport: 6061

    port: 6062
    timeout: 900s

    # paginationkey can be any random set of characters. *Must be the same across all Clair instances*.
    paginationkey:

  updater:
    # interval defines how often Clair will check for updates from its upstream vulnerability databases.
    interval: 6h
    notifier:
      attempts: 3
      renotifyinterval: 1h
      http:
        # QUAY_ENDPOINT defines the endpoint at which Quay Enterprise is running.
        # For example: https://myregistry.mycompany.com
        endpoint: https://$QUAY/secscan/notify
        proxy: http://localhost:6063

jwtproxy:
  signer_proxy:
    enabled: true
    listen_addr: :6063
    ca_key_file: /certificates/mitm.key # Generated internally, do not change.
    ca_crt_file: /certificates/mitm.crt # Generated internally, do not change.
    signer:
      issuer: security_scanner
      expiration_time: 5m
      max_skew: 1m
      nonce_length: 32
      private_key:
        type: autogenerated
        options:
          rotate_every: 12h
          key_folder: /config/
          key_server:
            type: keyregistry
            options:
              # QUAY_ENDPOINT defines the endpoint at which Quay Enterprise is running.
              # For example: https://myregistry.mycompany.com
              registry: https://$QUAY/keys/


  verifier_proxies:
  - enabled: true
    # The port at which Clair will listen.
    listen_addr: :6060

    # If Clair is to be served via TLS, uncomment these lines. See the "Running Clair under TLS"
    # section below for more information.
    # key_file: /config/clair.key
    # crt_file: /config/clair.crt

    verifier:
      # CLAIR_ENDPOINT is the endpoint at which this Clair will be accessible. Note that the port
      # specified here must match the listen_addr port a few lines above this.
      # Example: https://myclair.mycompany.com:6060
      audience: http://clair:6060

      upstream: http://localhost:6062
      key_server:
        type: keyregistry
        options:
          # QUAY_ENDPOINT defines the endpoint at which Quay Enterprise is running.
          # Example: https://myregistry.mycompany.com
          registry: https://$QUAY/keys/
EOF
```

```
kubectl -n quay-enterprise create configmap clair-config --from-file=config.yaml=config.yaml
```

```
kubectl create -f - <<EOF
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  namespace: quay-enterprise
  name: quay-enterprise-clair
  labels:
    quay-enterprise-component: clair
spec:
  replicas: 1
  selector:
    matchLabels:
      quay-enterprise-component: clair
  template:
    metadata:
      namespace: quay-enterprise
      labels:
        quay-enterprise-component: clair
    spec:
      containers:
      - name: quay-enterprise-clair
        image: quay.io/coreos/clair-jwt:v2.0.0
        lifecycle:
          postStart:
            exec:
              command: ["/bin/sh", "-c", "sleep 5; /bin/cat /usr/local/share/ca-certificates/ca.crt >> /etc/ssl/certs/ca-certificates.crt"]
        volumeMounts:
        - mountPath: /config/
          name: clair-config
        - mountPath: /usr/local/share/ca-certificates/
          name: rootca
      volumes:
      - name: clair-config
        configMap:
          name: clair-config
      - name: rootca
        secret:
          secretName: ca.crt
      imagePullSecrets:
        - name: coreos-pull-secret
---
apiVersion: v1
kind: Service
metadata:
  namespace: quay-enterprise
  name: clair
spec:
  type: ClusterIP
  ports:
    - protocol: TCP
      port: 6060
      targetPort: 6060
      name: clair
    - protocol: TCP
      port: 6061
      targetPort: 6061
      name: clair-health
  selector:
    quay-enterprise-component: clair
EOF
```

Verify the clair logs.

```
CLAIR_POD=`kubectl -n quay-enterprise get pods -l quay-enterprise-component=clair -o jsonpath={$.items[*].metadata.name}`
kubectl -n quay-enterprise logs $CLAIR_POD -f
```

Confirm that the clair service is healthy.

```
APP_POD=`kubectl -n quay-enterprise get pods -l quay-enterprise-component=app -o jsonpath={$.items[*].metadata.name}`
kubectl -n quay-enterprise exec -it $APP_POD -- curl -X GET -I http://clair:6061/health
```
